name: "Build and push Super Mario Docker image to Azure Container Registry"

on:
  push:
    branches:
      - main

env:
  ACR_NAME: devopsakaditacr                # ðŸ‘ˆ your ACR name (without .azurecr.io)
  IMAGE_NAME: devops-training              # ðŸ‘ˆ image name
  VERSION: ${{ github.run_number }}

jobs:
  build_and_push_to_acr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # âœ… Login to Azure using a service principal
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.AZURE_ACR_USERNAME }}
          password: ${{ secrets.AZURE_ACR_PASSWORD }}

      - name: Verify Docker login
        run: docker info

      - name: Build and Push Docker Image to ACR
        run: |
          IMAGE=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}
          docker build -t $IMAGE:${{ env.VERSION }} -t $IMAGE:latest .
          docker push $IMAGE:${{ env.VERSION }}
          docker push $IMAGE:latest

      - name: Save Docker image to tarball
        run: |
          IMAGE=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}
          docker save $IMAGE:${{ env.VERSION }} -o supermariolatestdockerimage.tar

      - name: Run Trivy vulnerability scanner in tarball mode
        uses: aquasecurity/trivy-action@master
        with:
          input: ./supermariolatestdockerimage.tar
          exit-code: '1'
          severity: 'CRITICAL,HIGH'




# name: "Build and push Super Mario Docker image with dynamic tag to Docker Hub"

# on:
#   push:
#     branches:
#       - main

# env:
#   VERSION: ${{ github.run_number }}

# jobs:
#   build_push_supermario_docker_image:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout Repository
#         uses: actions/checkout@v3

#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKERHUB_USERNAME }}
#           password: ${{ secrets.DOCKERHUB_TOKEN }}

#       - name: Verify Docker login
#         run: docker info

#       - name: Build and Push Docker Image
#         run: |
#           IMAGE_NAME=ebenezer97/devops-training
#           docker build -t $IMAGE_NAME:${{ env.VERSION }} .
#           docker push $IMAGE_NAME:${{ env.VERSION }}

#       - name: Save Docker image to tarball
#         run: |
#           docker save ebenezer97/devops-training:${{ env.VERSION }} -o supermariolatestdockerimage.tar

#       - name: Run Trivy vulnerability scanner in tarball mode
#         uses: aquasecurity/trivy-action@master
#         with:
#           input: ./supermariolatestdockerimage.tar
#           exit-code: '1'
#           severity: 'CRITICAL,HIGH'


